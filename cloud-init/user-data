#cloud-config

# Update & install required packages
package_update: true
package_upgrade: true
packages:
  - git
  - curl
  - zsh
  - nginx

# Create the student user
users:
  - name: student
    shell: /bin/zsh
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    lock_passwd: true
    ssh_authorized_keys:
      # Paste your public SSH key here!
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJBsbBUGz8spVwzmAWo2uS77uDF539KqTM2JDdxsCejH asahcaleb4@gmail.com

# Run commands for Oh My Zsh, SSH hardening, UFW, etc.
runcmd:
  - sleep 5  # Brief pause for stability

  # Install Oh My Zsh unattended as student
  - sudo -u student sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  - chown -R student:student /home/student/.oh-my-zsh /home/student/.zshrc

  # Harden SSH
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
  - echo "ChallengeResponseAuthentication no" >> /etc/ssh/sshd_config
  - echo "KbdInteractiveAuthentication no" >> /etc/ssh/sshd_config
  - systemctl restart ssh

  # Configure UFW
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw --force enable
  - systemctl enable ufw

  # Ensure Nginx is running
  - systemctl enable nginx
  - systemctl start nginx